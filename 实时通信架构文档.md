# Socket.IO å®æ—¶é€šä¿¡æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [æŠ€æœ¯åŸç†](#æŠ€æœ¯åŸç†)
3. [å®Œæ•´æµç¨‹](#å®Œæ•´æµç¨‹)
4. [æ ¸å¿ƒæœºåˆ¶](#æ ¸å¿ƒæœºåˆ¶)
5. [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
6. [ä»£ç å®ç°](#ä»£ç å®ç°)
7. [ä¼˜åŠ¿å¯¹æ¯”](#ä¼˜åŠ¿å¯¹æ¯”)

---

## æ¶æ„æ¦‚è¿°

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯ï¼ˆå­¦ç”Ÿç«¯ï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  uni-app     â”‚      â”‚  Web æµè§ˆå™¨  â”‚                    â”‚
â”‚  â”‚  å‰ç«¯åº”ç”¨    â”‚      â”‚  æµ‹è¯•é¡µé¢    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                      â”‚                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚ Socket.IO å®¢æˆ·ç«¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ WebSocket / HTTP é•¿è½®è¯¢
                     â”‚ (æºå¸¦ Session Cookie)
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚      â”‚  Socket.IO æœåŠ¡å™¨      â”‚                            â”‚
â”‚      â”‚  (ç«¯å£: 3000)          â”‚                            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚                 â”‚                 â”‚                     â”‚
â”‚  â”‚   è®¤è¯ä¸­é—´ä»¶     â”‚   æˆ¿é—´ç®¡ç†å™¨     â”‚   äº‹ä»¶åˆ†å‘å™¨        â”‚
â”‚  â”‚  (Session)      â”‚  (Room)         â”‚  (Emitter)          â”‚
â”‚  â”‚                 â”‚                 â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    â”‚                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚      â”‚  Express HTTP æœåŠ¡å™¨    â”‚                            â”‚
â”‚      â”‚  (REST API + Session)   â”‚                            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚      â”‚  MySQL æ•°æ®åº“           â”‚                            â”‚
â”‚      â”‚  (attendance_task)      â”‚                            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **Socket.IO æœåŠ¡å™¨**ï¼šå¤„ç† WebSocket è¿æ¥å’Œäº‹ä»¶åˆ†å‘
2. **æˆ¿é—´ç®¡ç†å™¨**ï¼šæŒ‰ç­çº§åˆ†ç»„å­¦ç”Ÿ socket
3. **è®¤è¯ä¸­é—´ä»¶**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆå…±äº« Express Sessionï¼‰
4. **äº‹ä»¶åˆ†å‘å™¨**ï¼šå°†ä»»åŠ¡æ¨é€å‘é€åˆ°æŒ‡å®šæˆ¿é—´

---

## æŠ€æœ¯åŸç†

### 1. Socket.IO å·¥ä½œåŸç†

Socket.IO æ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶çš„å®æ—¶åŒå‘é€šä¿¡åº“ï¼Œæä¾›ä»¥ä¸‹ç‰¹æ€§ï¼š

#### ä¼ è¾“å±‚åè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Socket.IO ä¼ è¾“å±‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. WebSocket (é¦–é€‰)                â”‚
â”‚     - å…¨åŒå·¥é€šä¿¡                     â”‚
â”‚     - ä½å»¶è¿Ÿ                         â”‚
â”‚     - é«˜æ•ˆ                           â”‚
â”‚                                     â”‚
â”‚  2. HTTP é•¿è½®è¯¢ (é™çº§)              â”‚
â”‚     - WebSocket ä¸å¯ç”¨æ—¶ä½¿ç”¨         â”‚
â”‚     - åŸºäº HTTP çš„æŒä¹…è¿æ¥           â”‚
â”‚     - è‡ªåŠ¨é™çº§å’Œå‡çº§                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªåŠ¨é™çº§æœºåˆ¶**ï¼š
- Socket.IO é¦–å…ˆå°è¯•å»ºç«‹ WebSocket è¿æ¥
- å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ° HTTP é•¿è½®è¯¢
- è¿æ¥ç¨³å®šåå¯è‡ªåŠ¨å‡çº§å› WebSocket

#### äº‹ä»¶é©±åŠ¨æ¨¡å‹

```javascript
// æœåŠ¡å™¨ç«¯
io.to('room-name').emit('event-name', data);

// å®¢æˆ·ç«¯
socket.on('event-name', (data) => {
    // å¤„ç†äº‹ä»¶
});
```

### 2. æˆ¿é—´ï¼ˆRoomï¼‰æœºåˆ¶

æˆ¿é—´æ˜¯ Socket.IO çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç”¨äºå°†å¤šä¸ª socket è¿æ¥åˆ†ç»„ï¼š

```
æˆ¿é—´ç»“æ„ï¼ˆæœåŠ¡å™¨å†…å­˜ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  class-1:                            â”‚
â”‚    â”œâ”€â”€ socket1 (å­¦ç”ŸA)               â”‚
â”‚    â”œâ”€â”€ socket2 (å­¦ç”ŸB)               â”‚
â”‚    â””â”€â”€ socket3 (å­¦ç”ŸC)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  class-2:                            â”‚
â”‚    â”œâ”€â”€ socket4 (å­¦ç”ŸD)               â”‚
â”‚    â””â”€â”€ socket5 (å­¦ç”ŸE)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æˆ¿é—´æ“ä½œ**ï¼š
- `socket.join(roomName)`ï¼šåŠ å…¥æˆ¿é—´
- `socket.leave(roomName)`ï¼šç¦»å¼€æˆ¿é—´
- `io.to(roomName).emit()`ï¼šå‘æˆ¿é—´å†…æ‰€æœ‰ socket å‘é€äº‹ä»¶
- `socket.to(roomName).emit()`ï¼šå‘æˆ¿é—´å†…é™¤è‡ªå·±å¤–çš„æ‰€æœ‰ socket å‘é€äº‹ä»¶

### 3. Session å…±äº«æœºåˆ¶

Socket.IO ä¸ Express å…±äº« Sessionï¼Œå®ç°ç»Ÿä¸€çš„èº«ä»½è®¤è¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·ç™»å½•ï¼ˆREST APIï¼‰                     â”‚
â”‚     POST /api/login                          â”‚
â”‚     â†“                                        â”‚
â”‚  2. Express è®¾ç½® Session                     â”‚
â”‚     req.session.userId = ...                 â”‚
â”‚     â†“                                        â”‚
â”‚  3. æµè§ˆå™¨ä¿å­˜ Session Cookie                â”‚
â”‚     connect.sid=xxx                          â”‚
â”‚     â†“                                        â”‚
â”‚  4. Socket.IO è¿æ¥æ—¶æºå¸¦ Cookie              â”‚
â”‚     â†“                                        â”‚
â”‚  5. Socket.IO ä¸­é—´ä»¶è§£æ Session             â”‚
â”‚     è·å–ç”¨æˆ·ä¿¡æ¯å¹¶é™„åŠ åˆ° socket              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´æµç¨‹

### é˜¶æ®µä¸€ï¼šå­¦ç”Ÿè¿æ¥å»ºç«‹

```
æ—¶é—´è½´ï¼š
T0 â†’ T1 â†’ T2 â†’ T3 â†’ T4
 â”‚    â”‚    â”‚    â”‚    â”‚
 â”‚    â”‚    â”‚    â”‚    â””â”€ 4. å‘é€ connected äº‹ä»¶
 â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€ 3. åŠ å…¥æˆ¿é—´ class-X
 â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. èº«ä»½éªŒè¯æˆåŠŸ
 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. ç”¨æˆ·å·²ç™»å½•
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **ç”¨æˆ·ç™»å½•ï¼ˆREST APIï¼‰**
   ```javascript
   POST /api/login
   â†’ è®¾ç½® req.session.userId = 6
   â†’ æµè§ˆå™¨ä¿å­˜ Cookie: connect.sid=xxx
   ```

2. **å®¢æˆ·ç«¯è¿æ¥ Socket.IO**
   ```javascript
   const socket = io('http://localhost:3000', {
       withCredentials: true  // è‡ªåŠ¨æºå¸¦ Cookie
   });
   ```

3. **æœåŠ¡å™¨æ¡æ‰‹è®¤è¯ï¼ˆä¸­é—´ä»¶ï¼‰**
   ```javascript
   io.use((socket, next) => {
       // ä» Cookie è§£æ Session
       sessionMiddleware(req, res, () => {
           // éªŒè¯é€šè¿‡ï¼Œé™„åŠ ç”¨æˆ·ä¿¡æ¯åˆ° socket
           socket.userId = req.session.userId;
           socket.classId = req.session.classId;
           next(); // å…è®¸è¿æ¥
       });
   });
   ```

4. **è‡ªåŠ¨åŠ å…¥æˆ¿é—´**
   ```javascript
   io.on('connection', (socket) => {
       if (socket.userRole === 'student') {
           const roomName = `class-${socket.classId}`;
           socket.join(roomName);  // åŠ å…¥ç­çº§æˆ¿é—´
       }
   });
   ```

5. **å‘é€è¿æ¥æˆåŠŸäº‹ä»¶**
   ```javascript
   socket.emit('connected', {
       success: true,
       room: 'class-1',
       userInfo: { ... }
   });
   ```

### é˜¶æ®µäºŒï¼šè€å¸ˆå‘å¸ƒä»»åŠ¡

```
æ—¶é—´è½´ï¼š
T0 â†’ T1 â†’ T2 â†’ T3 â†’ T4 â†’ T5
 â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
 â”‚    â”‚    â”‚    â”‚    â”‚    â””â”€ 5. å­¦ç”Ÿæ”¶åˆ°æ¨é€
 â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€ 4. å‘æˆ¿é—´æ¨é€äº‹ä»¶
 â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. æŸ¥è¯¢æˆ¿é—´æ‰€æœ‰ socket
 â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. åˆ›å»ºä»»åŠ¡åˆ°æ•°æ®åº“
 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. è€å¸ˆè°ƒç”¨ API
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. ä»»åŠ¡ä¿¡æ¯å‡†å¤‡
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **è€å¸ˆè°ƒç”¨ REST API**
   ```javascript
   POST /api/attendance-task
   {
       taskName: "æ—©è¯¾ç­¾åˆ°",
       classId: 1,
       startTime: "2024-01-15 08:00:00",
       endTime: "2024-01-15 09:00:00"
   }
   ```

2. **æœåŠ¡å™¨åˆ›å»ºä»»åŠ¡**
   ```javascript
   const [result] = await connection.execute(
       'INSERT INTO attendance_task ...'
   );
   const taskId = result.insertId;
   ```

3. **æŸ¥è¯¢ä»»åŠ¡å®Œæ•´ä¿¡æ¯**
   ```javascript
   const [taskInfoRows] = await connection.execute(
       'SELECT at.*, c.className, u.userName as teacherName ...'
   );
   ```

4. **é€šè¿‡ Socket.IO æ¨é€**
   ```javascript
   const roomName = `class-${classId}`;  // class-1
   global.io.to(roomName).emit('new-task', {
       success: true,
       message: 'æ”¶åˆ°æ–°çš„ç­¾åˆ°ä»»åŠ¡',
       task: {
           id: taskId,
           taskName: "æ—©è¯¾ç­¾åˆ°",
           classId: 1,
           // ... å…¶ä»–å­—æ®µ
       }
   });
   ```

5. **æˆ¿é—´å†…æ‰€æœ‰å­¦ç”Ÿæ”¶åˆ°æ¨é€**
   ```javascript
   // å­¦ç”Ÿç«¯è‡ªåŠ¨è§¦å‘
   socket.on('new-task', (data) => {
       console.log('æ”¶åˆ°æ–°ä»»åŠ¡:', data.task);
       // æ›´æ–°å‰ç«¯ä»»åŠ¡åˆ—è¡¨
   });
   ```

### é˜¶æ®µä¸‰ï¼šå­¦ç”Ÿä¸»åŠ¨æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰

```
å®¢æˆ·ç«¯               æœåŠ¡å™¨
  â”‚                    â”‚
  â”‚â”€â”€ emit('get-tasks')â”€>â”‚
  â”‚                    â”‚  æŸ¥è¯¢æ•°æ®åº“
  â”‚                    â”‚  è·å–ä»»åŠ¡åˆ—è¡¨
  â”‚<â”€â”€ tasks-response â”€â”€â”‚
  â”‚                    â”‚
```

---

## æ ¸å¿ƒæœºåˆ¶

### 1. è®¤è¯æœºåˆ¶

#### Session å…±äº«æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Express Session é…ç½®                                  â”‚
â”‚  app.use(session({                                     â”‚
â”‚      secret: 'xxx',                                    â”‚
â”‚      cookie: { maxAge: 24 * 60 * 60 * 1000 }          â”‚
â”‚  }));                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Socket.IO ä¸­é—´ä»¶ï¼ˆio.useï¼‰                            â”‚
â”‚  1. ä» socket.request.headers.cookie è·å– Cookie      â”‚
â”‚  2. è°ƒç”¨ sessionMiddleware è§£æ Session                â”‚
â”‚  3. éªŒè¯ req.session.userId æ˜¯å¦å­˜åœ¨                   â”‚
â”‚  4. å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ° socket å¯¹è±¡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç **ï¼š
```javascript
io.use((socket, next) => {
    const req = socket.request;
    sessionMiddleware(req, res, () => {
        if (req.session && req.session.userId) {
            socket.userId = req.session.userId;
            socket.classId = req.session.classId;
            // ... å…¶ä»–ä¿¡æ¯
            next(); // å…è®¸è¿æ¥
        } else {
            next(new Error('æœªç™»å½•')); // æ‹’ç»è¿æ¥
        }
    });
});
```

### 2. æˆ¿é—´ç®¡ç†æœºåˆ¶

#### æˆ¿é—´åŠ å…¥é€»è¾‘

```javascript
io.on('connection', (socket) => {
    // å­¦ç”Ÿè‡ªåŠ¨åŠ å…¥ç­çº§æˆ¿é—´
    if (socket.userRole === 'student' && socket.classId) {
        const roomName = `class-${socket.classId}`;
        socket.join(roomName);
        console.log(`å­¦ç”Ÿ ${socket.userAccount} åŠ å…¥æˆ¿é—´: ${roomName}`);
    }
});
```

#### æˆ¿é—´æ•°æ®ç»“æ„ï¼ˆSocket.IO å†…éƒ¨ï¼‰

```javascript
// Socket.IO å†…éƒ¨ç»´æŠ¤çš„æˆ¿é—´æ˜ å°„
rooms = {
    'class-1': Set([socket1, socket2, socket3, ...]),
    'class-2': Set([socket4, socket5, ...])
}
```

#### äº‹ä»¶æ¨é€é€»è¾‘

```javascript
// å‘æŒ‡å®šæˆ¿é—´çš„æ‰€æœ‰ socket æ¨é€
io.to('class-1').emit('new-task', data);

// Socket.IO å†…éƒ¨æ‰§è¡Œï¼š
// 1. æŸ¥æ‰¾æˆ¿é—´ 'class-1' çš„æ‰€æœ‰ socket
// 2. éå†è¿™äº› socketï¼Œé€ä¸ªå‘é€äº‹ä»¶
// 3. å­¦ç”Ÿç«¯ socket è‡ªåŠ¨æ¥æ”¶å¹¶è§¦å‘å›è°ƒ
```

### 3. äº‹ä»¶åˆ†å‘æœºåˆ¶

#### æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯ï¼ˆæ¨é€ï¼‰

```javascript
// å‘å•ä¸ª socket æ¨é€
socket.emit('event-name', data);

// å‘æˆ¿é—´å†…æ‰€æœ‰ socket æ¨é€
io.to('room-name').emit('event-name', data);

// å‘æˆ¿é—´å†…é™¤å‘é€è€…å¤–çš„æ‰€æœ‰ socket æ¨é€
socket.to('room-name').emit('event-name', data);

// å‘æ‰€æœ‰è¿æ¥çš„ socket æ¨é€
io.emit('event-name', data);
```

#### å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ï¼ˆè¯·æ±‚ï¼‰

```javascript
// å®¢æˆ·ç«¯å‘é€
socket.emit('get-tasks');

// æœåŠ¡å™¨æ¥æ”¶
socket.on('get-tasks', async () => {
    // å¤„ç†è¯·æ±‚
    socket.emit('tasks-response', data);
});
```

---

## æ•°æ®æµè½¬

### ä»»åŠ¡å‘å¸ƒæ•°æ®æµ

```
è€å¸ˆç«¯                    æœåŠ¡å™¨                      æ•°æ®åº“                   å­¦ç”Ÿç«¯
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚ POST /api/attendance-taskâ”‚                          â”‚                        â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚ INSERT INTO attendance_task                        â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                         â”‚  taskId = 1              â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚ SELECT ... FROM attendance_task                    â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                         â”‚  taskInfo {...}          â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚ io.to('class-1').emit('new-task', {...})          â”‚
  â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚                        â”‚
  â”‚ {success: true, taskId: 1}                         â”‚                        â”‚
  â”‚                         â”‚                          â”‚                        â”‚
  â”‚                         â”‚                          â”‚   æ”¶åˆ° new-task äº‹ä»¶   â”‚
  â”‚                         â”‚                          â”‚   è§¦å‘å‰ç«¯å›è°ƒ         â”‚
  â”‚                         â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### å…³é”®æ•°æ®ç»“æ„

#### 1. æ¨é€äº‹ä»¶æ•°æ®ç»“æ„

```json
{
    "success": true,
    "message": "æ”¶åˆ°æ–°çš„ç­¾åˆ°ä»»åŠ¡",
    "task": {
        "id": 1,
        "taskName": "æ—©è¯¾ç­¾åˆ°",
        "classId": 1,
        "className": "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2023çº§1ç­",
        "teacherId": 6,
        "teacherName": "å¼ è€å¸ˆ",
        "startTime": "2024-01-15 08:00:00",
        "endTime": "2024-01-15 09:00:00",
        "createTime": "2024-01-15 07:30:00",
        "status": "active"
    }
}
```

#### 2. è¿æ¥æˆåŠŸäº‹ä»¶æ•°æ®ç»“æ„

```json
{
    "success": true,
    "message": "è¿æ¥æˆåŠŸ",
    "room": "class-1",
    "userInfo": {
        "userId": 6,
        "userAccount": "student001",
        "userName": "æµ‹è¯•å­¦ç”Ÿ",
        "classId": 1
    }
}
```

---

## ä»£ç å®ç°

### 1. æœåŠ¡å™¨åˆå§‹åŒ–

```javascript
// app.js
const http = require('http');
const { Server } = require('socket.io');

// åˆ›å»º HTTP æœåŠ¡å™¨
const httpServer = http.createServer(app);

// åˆ›å»º Socket.IO æœåŠ¡å™¨
const io = new Server(httpServer, {
    cors: {
        origin: "*",
        methods: ["GET", "POST"],
        credentials: true  // å…è®¸æºå¸¦ Cookie
    },
    transports: ['websocket', 'polling']  // æ”¯æŒä¸¤ç§ä¼ è¾“æ–¹å¼
});

// å…¨å±€æš´éœ²ï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
global.io = io;
```

### 2. è®¤è¯ä¸­é—´ä»¶

```javascript
// Socket.IO è®¤è¯ä¸­é—´ä»¶
io.use((socket, next) => {
    const req = socket.request;
    
    // æ£€æŸ¥ Cookie
    if (!req.headers.cookie) {
        return next(new Error('æœªæ‰¾åˆ° session cookie'));
    }
    
    // åˆ›å»ºä¼ª response å¯¹è±¡ï¼ˆSocket.IO æ¡æ‰‹é˜¶æ®µéœ€è¦ï¼‰
    const res = {
        end: () => {},
        writeHead: () => {},
        cookie: () => {},
        setHeader: () => {}
    };
    
    // ä½¿ç”¨ Express session ä¸­é—´ä»¶è§£æ Session
    sessionMiddleware(req, res, () => {
        if (req.session && req.session.userId) {
            // éªŒè¯é€šè¿‡ï¼Œé™„åŠ ç”¨æˆ·ä¿¡æ¯åˆ° socket
            socket.userId = req.session.userId;
            socket.userAccount = req.session.userAccount;
            socket.userName = req.session.userName;
            socket.userRole = req.session.userRole;
            socket.classId = req.session.classId;
            socket.className = req.session.className;
            
            next(); // å…è®¸è¿æ¥
        } else {
            next(new Error('æœªç™»å½•æˆ– session æ— æ•ˆ'));
        }
    });
});
```

### 3. è¿æ¥å¤„ç†ä¸æˆ¿é—´ç®¡ç†

```javascript
io.on('connection', (socket) => {
    console.log(`ç”¨æˆ·è¿æ¥: ${socket.userAccount}`);
    
    // å­¦ç”Ÿè‡ªåŠ¨åŠ å…¥ç­çº§æˆ¿é—´
    if (socket.userRole === 'student' && socket.classId) {
        const roomName = `class-${socket.classId}`;
        socket.join(roomName);
        console.log(`å­¦ç”Ÿ ${socket.userAccount} åŠ å…¥æˆ¿é—´: ${roomName}`);
        
        // å‘é€è¿æ¥æˆåŠŸäº‹ä»¶
        socket.emit('connected', {
            success: true,
            message: 'è¿æ¥æˆåŠŸ',
            room: roomName,
            userInfo: {
                userId: socket.userId,
                userAccount: socket.userAccount,
                userName: socket.userName,
                classId: socket.classId
            }
        });
    }
    
    // å¤„ç†æ–­å¼€è¿æ¥
    socket.on('disconnect', () => {
        console.log(`ç”¨æˆ·æ–­å¼€è¿æ¥: ${socket.userAccount}`);
        // Socket.IO è‡ªåŠ¨ä»æˆ¿é—´ä¸­ç§»é™¤
    });
});
```

### 4. ä»»åŠ¡æ¨é€å®ç°

```javascript
// REST API æ¥å£ï¼šè€å¸ˆå‘å¸ƒä»»åŠ¡
app.post('/api/attendance-task', requireLogin, async (req, res) => {
    // ... å‚æ•°éªŒè¯ ...
    
    // åˆ›å»ºä»»åŠ¡
    const [result] = await connection.execute(
        'INSERT INTO attendance_task ...'
    );
    const taskId = result.insertId;
    
    // æŸ¥è¯¢ä»»åŠ¡å®Œæ•´ä¿¡æ¯
    const [taskInfoRows] = await connection.execute(
        'SELECT at.*, c.className, u.userName as teacherName ...'
    );
    const taskInfo = taskInfoRows[0];
    
    // é€šè¿‡ Socket.IO æ¨é€
    if (global.io) {
        const roomName = `class-${classId}`;
        global.io.to(roomName).emit('new-task', {
            success: true,
            message: 'æ”¶åˆ°æ–°çš„ç­¾åˆ°ä»»åŠ¡',
            task: {
                id: taskId,
                taskName: taskName,
                classId: classId,
                className: taskInfo.className,
                teacherId: teacherId,
                teacherName: taskInfo.teacherName,
                startTime: startTime,
                endTime: endTime,
                createTime: taskInfo.createTime,
                status: 'active'
            }
        });
        console.log(`ç­¾åˆ°ä»»åŠ¡å·²æ¨é€ç»™æˆ¿é—´: ${roomName}, ä»»åŠ¡ID: ${taskId}`);
    }
    
    // è¿”å› REST API å“åº”
    res.json({
        success: true,
        message: 'ç­¾åˆ°ä»»åŠ¡å‘å¸ƒæˆåŠŸ',
        data: { taskId, ... }
    });
});
```

### 5. ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰

```javascript
// Socket.IO äº‹ä»¶å¤„ç†
socket.on('get-tasks', async () => {
    if (socket.userRole !== 'student' || !socket.classId) {
        socket.emit('tasks-response', {
            success: false,
            message: 'æƒé™ä¸è¶³'
        });
        return;
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    const [rows] = await connection.execute(
        `SELECT at.*, c.className, u.userName as teacherName
         FROM attendance_task at
         LEFT JOIN class c ON at.classId = c.id
         LEFT JOIN user u ON at.teacherId = u.id
         WHERE at.classId = ?
         ORDER BY at.createTime DESC`,
        [socket.classId]
    );
    
    // å‘é€å“åº”
    socket.emit('tasks-response', {
        success: true,
        data: rows
    });
});
```

---

## ä¼˜åŠ¿å¯¹æ¯”

### Socket.IO å®æ—¶æ¨é€ vs REST API è½®è¯¢

| ç‰¹æ€§ | Socket.IO å®æ—¶æ¨é€ | REST API è½®è¯¢ |
|------|-------------------|---------------|
| **é€šä¿¡æ–¹å¼** | æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ | å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ |
| **è¿æ¥ç±»å‹** | é•¿è¿æ¥ï¼ˆæŒç»­ï¼‰ | çŸ­è¿æ¥ï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰ |
| **å®æ—¶æ€§** | å®æ—¶ï¼ˆ< 100msï¼‰ | å»¶è¿Ÿå–å†³äºè½®è¯¢é—´éš” |
| **æœåŠ¡å™¨è´Ÿè½½** | ä½ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ | é«˜ï¼ˆé¢‘ç¹è¯·æ±‚ï¼‰ |
| **ç½‘ç»œå¼€é”€** | ä½ï¼ˆåªæ¨é€å˜æ›´ï¼‰ | é«˜ï¼ˆé‡å¤æŸ¥è¯¢ï¼‰ |
| **èµ„æºæ¶ˆè€—** | å†…å­˜ï¼ˆç»´æŠ¤è¿æ¥ï¼‰ | CPUï¼ˆå¤„ç†è¯·æ±‚ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | å³æ—¶é€šçŸ¥ | éœ€è¦åˆ·æ–° |

### æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹

**åœºæ™¯ï¼š50ä¸ªå­¦ç”Ÿï¼Œæ¯5ç§’è½®è¯¢ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨**

#### REST API è½®è¯¢æ–¹å¼ï¼š
```
è¯·æ±‚é¢‘ç‡ï¼š50 å­¦ç”Ÿ Ã— (3600ç§’ / 5ç§’) = 36,000 æ¬¡/å°æ—¶
æ•°æ®åº“æŸ¥è¯¢ï¼š36,000 æ¬¡/å°æ—¶
å³ä½¿æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œä¹Ÿä¼šæŸ¥è¯¢
```

#### Socket.IO å®æ—¶æ¨é€æ–¹å¼ï¼š
```
è¿æ¥æ•°ï¼š50 ä¸ªé•¿è¿æ¥
æ¨é€æ¬¡æ•°ï¼šä»…åœ¨ä»»åŠ¡å‘å¸ƒæ—¶æ¨é€ï¼ˆä¾‹å¦‚ï¼š10æ¬¡/å°æ—¶ï¼‰
æ•°æ®åº“æŸ¥è¯¢ï¼šåªåœ¨æ¨é€æ—¶æŸ¥è¯¢ä¸€æ¬¡
æ— ä»»åŠ¡æ—¶ï¼š0 æŸ¥è¯¢
```

**ç»“è®º**ï¼šSocket.IO æ–¹å¼åœ¨å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€—ä¸Šéƒ½æœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© Socket.IOï¼Ÿ
- âœ… è‡ªåŠ¨é™çº§æœºåˆ¶ï¼ˆWebSocket â†’ HTTP é•¿è½®è¯¢ï¼‰
- âœ… æˆ¿é—´æœºåˆ¶ï¼ˆæ–¹ä¾¿åˆ†ç»„æ¨é€ï¼‰
- âœ… äº‹ä»¶é©±åŠ¨ï¼ˆç®€æ´çš„ APIï¼‰
- âœ… è·¨å¹³å°æ”¯æŒï¼ˆæµè§ˆå™¨ã€ç§»åŠ¨ç«¯ã€Node.jsï¼‰

### 2. ä¸ºä»€ä¹ˆå…±äº« Sessionï¼Ÿ
- âœ… ç»Ÿä¸€è®¤è¯æœºåˆ¶ï¼ˆREST API å’Œ Socket.IO ä¸€è‡´ï¼‰
- âœ… æ— éœ€é¢å¤– token ç®¡ç†
- âœ… å®‰å…¨æ€§é«˜ï¼ˆHttpOnly Cookieï¼‰
- âœ… å®ç°ç®€å•

### 3. æˆ¿é—´æœºåˆ¶çš„ä¼˜åŠ¿ï¼Ÿ
- âœ… ç²¾ç¡®æ¨é€ï¼ˆåªæ¨é€ç»™ç›®æ ‡ç­çº§ï¼‰
- âœ… è‡ªåŠ¨ç®¡ç†ï¼ˆæ–­å¼€è¿æ¥è‡ªåŠ¨ç¦»å¼€æˆ¿é—´ï¼‰
- âœ… é«˜æ•ˆåˆ†å‘ï¼ˆä¸€æ¬¡æ¨é€ï¼Œå¤šäººæ¥æ”¶ï¼‰
- âœ… æ˜“äºæ‰©å±•ï¼ˆæ”¯æŒå¤šæˆ¿é—´ï¼‰

### 4. å®æ—¶æ€§çš„ä¿è¯ï¼Ÿ
- âœ… WebSocket é•¿è¿æ¥ï¼ˆä½å»¶è¿Ÿï¼‰
- âœ… æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼ˆæ— éœ€ç­‰å¾…è¯·æ±‚ï¼‰
- âœ… äº‹ä»¶é©±åŠ¨ï¼ˆç«‹å³è§¦å‘å›è°ƒï¼‰
- âœ… å†…å­˜æ“ä½œï¼ˆé¿å…æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿï¼‰

---

## æ‰©å±•å¯èƒ½æ€§

### 1. å¤šæˆ¿é—´æ”¯æŒ
```javascript
// å­¦ç”Ÿå¯ä»¥åŠ å…¥å¤šä¸ªæˆ¿é—´
socket.join('class-1');
socket.join('notification-room');
socket.join('private-chat-room');
```

### 2. ç§èŠåŠŸèƒ½
```javascript
// å‘ç‰¹å®šç”¨æˆ·å‘é€æ¶ˆæ¯
io.to(`user-${userId}`).emit('private-message', data);
```

### 3. åœ¨çº¿çŠ¶æ€
```javascript
// æŸ¥è¯¢æˆ¿é—´å†…åœ¨çº¿äººæ•°
const sockets = await io.in('class-1').fetchSockets();
console.log(`åœ¨çº¿äººæ•°: ${sockets.length}`);
```

### 4. æ¶ˆæ¯æŒä¹…åŒ–
```javascript
// æ¨é€åä¿å­˜åˆ°æ•°æ®åº“
await saveNotificationToDB(userId, taskId);
```

---

## æ³¨æ„äº‹é¡¹

### 1. è¿æ¥ç®¡ç†
- âœ… æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨ä»æˆ¿é—´ç§»é™¤
- âœ… é‡è¿æ—¶éœ€é‡æ–°åŠ å…¥æˆ¿é—´ï¼ˆSocket.IO è‡ªåŠ¨å¤„ç†ï¼‰
- âš ï¸ æ³¨æ„å†…å­˜æ³„æ¼ï¼ˆå¤§é‡é•¿æ—¶é—´è¿æ¥ï¼‰

### 2. è®¤è¯å®‰å…¨
- âœ… å¿…é¡»é€šè¿‡ Session è®¤è¯
- âœ… Cookie éœ€è®¾ç½® HttpOnly
- âš ï¸ æ³¨æ„è·¨åŸŸ Cookie ä¼ é€’ï¼ˆCORS é…ç½®ï¼‰

### 3. é”™è¯¯å¤„ç†
- âœ… è¿æ¥å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆSocket.IO å†…ç½®ï¼‰
- âœ… ç½‘ç»œæ–­å¼€è‡ªåŠ¨é‡è¿
- âš ï¸ å¤„ç†è®¤è¯å¤±è´¥æƒ…å†µ

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… åªåœ¨éœ€è¦æ—¶æ¨é€ï¼ˆé¿å…æ— æ•ˆæ¨é€ï¼‰
- âœ… ä½¿ç”¨æˆ¿é—´æœºåˆ¶ï¼ˆç²¾ç¡®æ¨é€ï¼‰
- âš ï¸ æ³¨æ„æœåŠ¡å™¨å†…å­˜å ç”¨ï¼ˆå¤§é‡è¿æ¥ï¼‰

---

