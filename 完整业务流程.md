# 人脸识别系统业务流程

## 系统角色与权限

### 角色定义
- **学生 (student)**: 注册时必须选择班级，可以查看自己班级的签到任务并进行签到
- **老师 (teacher)**: 预置账号，可以发布签到任务、查看签到统计

### 权限矩阵
| 功能 | 学生 | 老师 |
|------|------|------|
| 注册账号 | ✅ | ❌ |
| 登录系统 | ✅ | ✅ |
| 人脸注册 | ✅ | ✅ |
| 人脸识别签到 | ✅ | ❌ |
| 查看班级列表 | ✅ | ✅ |
| 发布签到任务 | ❌ | ✅ |
| 查看签到任务 | ✅ (仅自己班级) | ✅ (自己发布的) |
| 查看签到统计 | ❌ | ✅ |

## 用户管理流程

### 1. 学生注册流程
```
学生填写注册信息 → 选择班级 → 前端验证 → 发送注册请求 → 后端验证 → 密码加密 → 存储数据库 → 返回注册结果
```

**详细步骤**：
1. **前端收集**：学生输入账号、密码、姓名
2. **班级选择**：从班级列表中选择班级
3. **前端验证**：检查必填字段、格式验证、班级选择
4. **发送请求**：POST /api/register
5. **后端验证**：检查账号是否已存在、班级是否存在
6. **密码加密**：使用bcrypt加密密码
7. **数据库存储**：插入学生记录（角色固定为student）
8. **返回结果**：返回注册成功/失败信息

**业务规则**：
- 只支持学生注册，角色固定为student
- 账号必须唯一
- 密码长度至少6位
- 姓名可选填写
- 必须选择班级
- 老师账号已预置，无需注册
- 注册成功后用户状态为未注册人脸

### 2. 老师账号管理
```
系统预置老师账号 → 数据库存储 → 老师直接登录使用
```

**预置数据**：
- teacher001 (张老师) - 密码: 123456
- teacher002 (李老师) - 密码: 123456
- teacher003 (王老师) - 密码: 123456
- teacher004 (赵老师) - 密码: 123456
- teacher005 (刘老师) - 密码: 123456

**业务规则**：
- 老师账号由系统预置
- 老师无需注册，直接使用预置账号登录
- 老师角色固定为teacher

### 3. 用户登录流程
```
用户输入账号密码 → 前端验证 → 发送登录请求 → 后端验证 → 密码比对 → 创建Session → 返回用户信息
```

**详细步骤**：
1. **前端收集**：用户输入账号和密码
2. **发送请求**：POST /api/login
3. **数据库查询**：根据账号查找用户
4. **密码验证**：使用bcrypt比对密码
5. **Session创建**：存储用户信息到session（包含角色和班级信息）
6. **返回信息**：返回用户基本信息、角色、班级和登录状态

**业务规则**：
- 账号和密码必须匹配
- 登录成功后创建session
- 返回用户ID、账号、姓名、角色、班级ID、人脸注册状态
- 根据角色返回不同的功能权限

### 4. 用户登出流程
```
用户点击登出 → 发送登出请求 → 销毁Session → 清除Cookie → 返回登出成功
```

**详细步骤**：
1. **发送请求**：POST /api/logout
2. **Session销毁**：req.session.destroy()
3. **Cookie清除**：浏览器自动清除session cookie
4. **返回确认**：返回登出成功信息

## 班级管理流程

### 1. 班级数据管理
```
系统预置班级数据 → 数据库存储 → 前端获取班级列表 → 学生注册时选择
```

**预置班级数据**：
- 计算机科学与技术2023级1班 (CS2023-1)
- 计算机科学与技术2023级2班 (CS2023-2)
- 软件工程2023级1班 (SE2023-1)
- 软件工程2023级2班 (SE2023-2)
- 人工智能2023级1班 (AI2023-1)

### 2. 获取班级列表流程
```
前端请求班级列表 → 后端查询数据库 → 返回班级信息 → 前端显示供选择
```

**详细步骤**：
1. **前端请求**：GET /api/classes
2. **数据库查询**：查询所有班级信息
3. **数据返回**：返回班级ID、名称、代码
4. **前端显示**：供学生注册时选择

**业务规则**：
- 班级数据由系统预置
- 学生注册时必须选择班级
- 老师可以查看所有班级信息

## 签到任务管理流程

### 1. 老师发布签到任务流程
```
老师登录 → 填写任务信息 → 选择目标班级 → 设置时间 → 发送请求 → 后端验证 → 创建任务 → 返回结果
```

**详细步骤**：
1. **老师登录**：验证老师身份
2. **填写信息**：输入任务名称、选择班级、设置开始和结束时间
3. **前端验证**：检查必填字段、时间逻辑
4. **发送请求**：POST /api/attendance-task
5. **后端验证**：验证老师权限、班级存在性、老师班级权限、时间逻辑
6. **创建任务**：插入签到任务记录
7. **返回结果**：返回任务创建成功/失败信息

**业务规则**：
- 只有老师可以发布签到任务
- 老师只能为自己所在的班级发布签到任务
- 任务名称最多100字符
- 开始时间必须早于结束时间
- 结束时间必须晚于当前时间
- 目标班级必须存在且老师必须属于该班级

### 2. 查看签到任务流程
```
用户登录 → 根据角色查询 → 返回任务列表 → 前端显示
```

**详细步骤**：
1. **用户登录**：验证用户身份和角色
2. **角色判断**：
   - 学生：查询自己班级的任务
   - 老师：查询自己发布的任务
3. **数据查询**：GET /api/attendance-tasks
4. **结果返回**：返回任务列表和详细信息
5. **前端显示**：根据角色显示不同的任务列表

**业务规则**：
- 学生只能查看自己班级的任务
- 老师只能查看自己发布的任务
- 支持按状态和班级筛选
- 返回任务详细信息包括班级名称、老师姓名

### 3. 签到统计查看流程
```
老师登录 → 选择任务 → 发送统计请求 → 后端计算统计 → 返回统计数据
```

**详细步骤**：
1. **老师登录**：验证老师身份
2. **选择任务**：选择要查看统计的签到任务
3. **发送请求**：GET /api/attendance-stats?taskId=xxx
4. **数据统计**：计算总学生数、已签到数、签到率
5. **详情查询**：获取签到学生详情
6. **结果返回**：返回完整的统计数据

**业务规则**：
- 只有老师可以查看签到统计
- 统计包括总学生数、已签到数、签到率
- 提供详细的签到学生信息
- 按签到时间排序

## 人脸识别流程

### 1. 人脸注册流程（自动保存样本并重训练，支持首次注册冷启动）

**首次注册流程**（用户 `faceRegistered=0`）：
```
用户上传人脸图片 → 前端验证 → 发送注册请求 → 后端接收图片 → 跳过识别校验 → 直接复制样本到训练集 → 触发训练脚本生成/更新模型 → 更新用户状态 → 返回注册结果
```

**非首次注册流程**（用户 `faceRegistered=1`）：
```
用户上传人脸图片 → 前端验证 → 发送注册请求 → 后端接收图片 → 调用Python识别校验 → 匹配成功：复制样本到训练集 → 触发训练脚本生成/更新模型 → 更新用户状态 → 返回注册结果
```

**详细步骤**：

**首次注册场景**：
1. **图片上传**：用户选择并上传人脸图片
2. **前端验证**：检查文件类型、大小
3. **发送请求**：POST /api/face-register (multipart/form-data)
4. **后端处理**：使用multer接收图片文件
5. **查询用户状态**：检查 `user.faceRegistered`，若为 0 则进入冷启动流程
6. **跳过识别校验**：首次注册不需要识别匹配（模型尚未包含该用户）
7. **样本入库**：直接复制图片到 `opencv/face_get/Facedata/<name>.<userId>.<timestamp>.<ext>`
8. **训练更新**：调用 `opencv/face_get/trainner.py` 生成/更新 `face_trainer/trainer.yml`
9. **状态更新**：后端更新用户 `faceRegistered=1`
10. **返回结果**：`{ success:true, message:'人脸注册成功（首次注册）', data:{ savedToDataset:true, retrained:true, coldStart:true } }`

**非首次注册场景**：
1. **图片上传**：用户选择并上传人脸图片
2. **前端验证**：检查文件类型、大小
3. **发送请求**：POST /api/face-register (multipart/form-data)
4. **后端处理**：使用multer接收图片文件
5. **查询用户状态**：检查 `user.faceRegistered`，若为 1 则进入校验流程
6. **Python识别校验**：后端以子进程调用 `opencv/face_get/rec.py <图片路径>`，解析 stdout JSON
7. **匹配验证**：只有当识别结果中的 `userId` 与提交的 `userId` 一致时，才继续流程
8. **样本入库**：匹配成功后复制图片到 `opencv/face_get/Facedata/<name>.<userId>.<timestamp>.<ext>`
9. **训练更新**：调用 `opencv/face_get/trainner.py` 生成/更新 `face_trainer/trainer.yml`
10. **状态更新**：确保 `user.faceRegistered=1`
11. **返回结果**：`{ success:true, data:{ savedToDataset:true, retrained:true, coldStart:false } }`

**业务规则**：
- 图片必须是有效的图片格式
- 图片大小不超过20MB
- 训练数据与数据库 `user.id` 必须对齐（文件名中的 `id`）
- **首次注册（coldStart: true）**：跳过识别校验，直接入库并重训练，适合新用户首次录入人脸
- **非首次注册（coldStart: false）**：需要识别校验通过后才保存样本，防止误将他人照片加入训练集
- 每次注册成功后都会自动重训练，模型实时更新
- 注册成功后用户状态更新为已注册人脸

### 2. 人脸识别流程（含自动签到）
```
学生上传识别图片 → 选择签到任务 → 前端验证 → 发送识别请求 → 后端接收图片 → 调用算法组API → 算法组比对特征 → 返回识别结果 → 查询用户信息 → 验证签到任务 → 自动记录签到 → 返回识别结果和签到状态
```

**详细步骤**：
1. **图片上传**：学生上传待识别的人脸图片
2. **任务选择**：选择要签到的任务（可选）
3. **发送请求**：POST /api/face-recognition (包含taskId)
4. **后端处理**：接收并存储图片文件
5. **算法组调用**：发送图片给算法组进行识别
6. **特征比对**：算法组与已注册特征进行比对
7. **结果返回**：算法组返回识别结果
8. **用户查询**：如果识别成功，查询用户详细信息
9. **任务验证**：如果提供了taskId，验证任务的有效性和时间范围
10. **自动签到**：验证通过后自动记录签到到数据库
11. **结果返回**：返回识别结果、用户信息和签到状态

**业务规则**：
- 只有学生可以进行人脸识别签到
- 识别成功返回用户信息和签到状态
- 识别失败返回未识别信息
- 如果提供了taskId，会验证任务的有效性
- 任务必须在有效时间范围内
- 学生必须属于任务的目标班级
- 签到记录失败不影响识别结果

## 签到管理流程

### 1. 自动签到流程（集成在人脸识别中）
```
人脸识别成功 → 获取用户ID → 验证签到任务 → 自动记录签到 → 返回签到状态
```

**详细步骤**：
1. **人脸识别**：学生通过人脸识别验证身份
2. **获取用户ID**：从识别结果中获取用户ID和班级信息
3. **任务验证**：如果提供了taskId，验证任务的有效性
4. **自动签到**：验证通过后系统自动插入签到记录到数据库
5. **状态返回**：在识别结果中包含签到状态

**业务规则**：
- 只有学生可以进行签到
- 签到时间自动记录为当前时间
- 默认签到状态为成功(1)
- 如果提供了taskId，会关联到具体的签到任务
- 任务必须在有效时间范围内
- 学生必须属于任务的目标班级
- 签到记录失败不影响识别结果
- 每次识别成功自动生成签到记录

### 2. 签到数据管理
```
签到记录自动创建 → 关联签到任务 → 数据库存储 → 统计分析
```

**数据特点**：
- 由系统自动创建，无需用户操作
- 与人脸识别结果绑定
- 可以关联到具体的签到任务
- 支持按任务进行数据分析和统计
- 记录完整的签到时间信息
- 支持签到率计算和学生详情查询

## 系统集成流程

### 1. 算法组集成流程
```
后端接收图片 → 调用算法组API → 传递图片路径 → 算法组处理 → 返回处理结果 → 后端处理结果
```

**集成要点**：
- **接口标准化**：统一的API调用格式
- **错误处理**：算法组服务异常处理
- **超时控制**：设置合理的请求超时时间
- **重试机制**：失败时的重试策略

### 2. 前后端交互流程
```
前端用户操作 → 发送HTTP请求 → 后端API处理 → 数据库操作 → 返回JSON响应 → 前端界面更新
```

**交互特点**：
- **RESTful API**：标准化的接口设计
- **JSON格式**：统一的数据交换格式
- **状态码**：HTTP状态码表示请求结果
- **错误处理**：统一的错误信息格式

## 数据流转流程

### 1. 用户数据流转
```
学生注册 → 选择班级 → 密码加密 → 数据库存储 → 登录验证 → Session存储 → 业务操作 → 数据更新
```

### 2. 班级数据流转
```
系统预置班级 → 数据库存储 → 前端获取 → 学生注册选择 → 签到任务关联
```

### 3. 签到任务数据流转
```
老师发布任务 → 数据库存储 → 学生查看任务 → 人脸识别签到 → 关联签到记录
```

### 4. 图片数据流转
```
学生上传 → 文件接收 → 本地存储 → 算法组调用 → 特征提取 → 结果返回 → 状态更新
```

### 5. 签到数据流转
```
人脸识别成功 → 验证签到任务 → 自动签到记录生成 → 关联任务ID → 数据库存储 → 统计分析
```

### 6. 统计数据流转
```
签到记录生成 → 按任务聚合 → 计算签到率 → 生成统计报告 → 老师查看
```

## 异常处理流程

### 1. 用户认证异常
```
认证失败 → 错误信息返回 → 前端提示 → 用户重新输入
```

### 2. 文件上传异常
```
文件过大 → 大小限制 → 错误提示 → 用户重新选择
文件格式错误 → 类型检查 → 错误提示 → 用户重新上传
```

### 3. 算法组调用异常
```
算法组服务不可用 → 超时处理 → 错误返回 → 用户重试
识别失败 → 结果处理 → 友好提示 → 用户重新识别
签到记录失败 → 错误日志 → 不影响识别结果 → 系统继续运行
```

### 4. 角色权限异常
```
学生访问老师功能 → 权限检查 → 403错误 → 友好提示
老师访问学生功能 → 权限检查 → 403错误 → 友好提示
未登录访问受保护接口 → 401错误 → 跳转登录页面
```

### 5. 签到任务异常
```
任务时间已过期 → 时间验证 → 错误提示 → 学生重新选择
学生不属于目标班级 → 班级验证 → 错误提示 → 学生确认班级
任务不存在 → 任务验证 → 错误提示 → 老师检查任务
老师跨班级发布任务 → 班级权限验证 → 错误提示 → 老师选择正确班级
```

### 6. 班级管理异常
```
班级不存在 → 班级验证 → 错误提示 → 学生重新选择
班级数据加载失败 → 数据库查询异常 → 错误提示 → 系统重试
```

## 完整业务流程总结

### 学生端流程
```
学生注册 → 选择班级 → 人脸注册 → 查看签到任务 → 人脸识别签到 → 查看签到状态
```

### 老师端流程
```
老师登录 → 发布签到任务 → 查看任务列表 → 查看签到统计 → 分析签到数据
```

### 系统管理流程
```
系统初始化 → 预置班级和老师数据 → 学生注册管理 → 签到任务管理 → 数据统计分析
```

这些业务流程构成了完整的人脸识别签到系统，支持角色管理、班级管理和签到任务管理，形成了完整的业务闭环。通过角色分离和功能集成，系统更加高效、安全和易用。
